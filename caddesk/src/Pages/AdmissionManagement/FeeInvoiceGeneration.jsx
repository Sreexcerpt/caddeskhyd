// import React from "react";

// const FeeInvoiceGeneration = () => {
//   return (
//     <div>
//       <div class="page-wrapper">
//         <div class="content">
//           <div class="row">
//             <div class="col-md-12">
//               {/* <!-- Page Header --> */}
//               <div class="page-header">
//                 <div class="row align-items-center">
//                   <div class="col-8">
//                     <h4 >
//                       FeeInvoiceGeneration<span class="count-title">123</span>
//                     </h4>
//                   </div>
//                   <div class="col-4 text-end">
//                     <div class="head-icons">
//                       <a
//                         href="contact-grid.html"
//                         data-bs-toggle="tooltip"
//                         data-bs-placement="top"
//                         data-bs-original-title="Refresh"
//                       >
//                         <i class="ti ti-refresh-dot"></i>
//                       </a>
//                       <a
//                         href="javascript:void(0);"
//                         data-bs-toggle="tooltip"
//                         data-bs-placement="top"
//                         data-bs-original-title="Collapse"
//                         id="collapse-header"
//                       >
//                         <i class="ti ti-chevrons-up"></i>
//                       </a>
//                     </div>
//                   </div>
//                 </div>
//               </div>
//               {/* <!-- /Page Header --> */}

//               {/* <!-- Card --> */}
//               <div class="card">
//                 <div class="card-body">
//                   {/* <!-- Contact Grid --> */}
//                   <div class="row">
//                     <div class="col-xl-12">
//                       <div class="card">
//                         <div class="card-header justify-content-between">
//                           <div class="card-title">FeeInvoiceGeneration</div>
//                         </div>
//                         <div class="card-body">
//                           <div class="table-responsive">
//                             <table class="table text-nowrap table-hover">
//                               <thead>
//                                 <tr>
//                                   <th>S.no</th>
//                                   <th scope="col">Invoice number</th>
//                                   <th scope="col">Name</th>
//                                   <th scope="col">Date</th>
//                                   <th scope="col">Course</th>
//                                   <th scope="col">Amount Paid</th>
//                                   <th scope="col">Payment Mode</th>
//                                   <th scope="col">Status</th>
//                                 </tr>
//                               </thead>
//                               <tbody>
//                                 <tr>
//                                   <td>1</td>
//                                   <td>#4536478939</td>
//                                   <td>
//                                     <div class="d-flex align-items-center">
//                                       <div>
//                                         <div class="lh-1">
//                                           <span>Vijay kumar</span>
//                                         </div>
//                                         <div class="lh-1">
//                                           <span class="fs-11 text-muted">
//                                             <a
//                                               href="/cdn-cgi/l/email-protection"
//                                               class="__cf_email__"
//                                               data-cfemail="9cf6f3fdf2f2fdeff1f5e8f4ada8dcf9e4fdf1ecf0f9b2fff3f1"
//                                             >
//                                               +9964537264
//                                             </a>
//                                           </span>
//                                         </div>
//                                       </div>
//                                     </div>
//                                   </td>
//                                   <td>2-5-2021</td>
//                                   <td>
//                                     <span>Solid Works</span>
//                                   </td>
//                                   <td>
//                                     <div class="avatar-list-stacked">
//                                       <span>2000</span>
//                                     </div>
//                                   </td>
//                                   <td>UPI</td>
//                                   <td>
//                                     <div class="hstack gap-2 fs-15">
//                                       <a
//                                         href="/Invoice"
//                                         class="btn btn-icon btn-sm btn-soft-info rounded-pill"
//                                       >
//                                         <i class="feather-download"></i>
//                                       </a>
//                                       <a
//                                         href="javascript:void(0);"
//                                         class="btn btn-icon btn-sm btn-soft-info rounded-pill"
//                                       >
//                                         <i class="feather-edit"></i>
//                                       </a>
//                                       <a
//                                         href="javascript:void(0);"
//                                         class="btn btn-icon btn-sm btn-soft-danger rounded-pill"
//                                       >
//                                         <i class="feather-trash"></i>
//                                       </a>
//                                     </div>
//                                   </td>
//                                 </tr>
//                                 <tr>
//                                   <td>2</td>
//                                   <td>#4536478939</td>
//                                   <td>
//                                     <div class="d-flex align-items-center">
//                                       <div>
//                                         <div class="lh-1">
//                                           <span>Vijay kumar</span>
//                                         </div>
//                                         <div class="lh-1">
//                                           <span class="fs-11 text-muted">
//                                             <a
//                                               href="/cdn-cgi/l/email-protection"
//                                               class="__cf_email__"
//                                               data-cfemail="9cf6f3fdf2f2fdeff1f5e8f4ada8dcf9e4fdf1ecf0f9b2fff3f1"
//                                             >
//                                               +9964537264
//                                             </a>
//                                           </span>
//                                         </div>
//                                       </div>
//                                     </div>
//                                   </td>
//                                   <td>2-3-2024</td>
//                                   <td>
//                                     <span>3DMAX</span>
//                                   </td>
//                                   <td>
//                                     <div class="avatar-list-stacked">
//                                       <span>2000</span>
//                                     </div>
//                                   </td>
//                                   <td>Online Mode</td>
//                                   <td>
//                                     <div class="hstack gap-2 fs-15">
//                                       <a
//                                         href="javascript:void(0);"
//                                         class="btn btn-icon btn-sm btn-soft-info rounded-pill"
//                                       >
//                                         <i class="feather-download"></i>
//                                       </a>
//                                       <a
//                                         href="javascript:void(0);"
//                                         class="btn btn-icon btn-sm btn-soft-info rounded-pill"
//                                       >
//                                         <i class="feather-edit"></i>
//                                       </a>
//                                       <a
//                                         href="javascript:void(0);"
//                                         class="btn btn-icon btn-sm btn-soft-danger rounded-pill"
//                                       >
//                                         <i class="feather-trash"></i>
//                                       </a>
//                                     </div>
//                                   </td>
//                                 </tr>
//                                 <tr>
//                                   <td>3</td>
//                                   <td>#4536478939</td>
//                                   <td>
//                                     <div class="d-flex align-items-center">
//                                       <div>
//                                         <div class="lh-1">
//                                           <span>Vijay kumar</span>
//                                         </div>
//                                         <div class="lh-1">
//                                           <span class="fs-11 text-muted">
//                                             <a
//                                               href="/cdn-cgi/l/email-protection"
//                                               class="__cf_email__"
//                                               data-cfemail="9cf6f3fdf2f2fdeff1f5e8f4ada8dcf9e4fdf1ecf0f9b2fff3f1"
//                                             >
//                                               +9964537264
//                                             </a>
//                                           </span>
//                                         </div>
//                                       </div>
//                                     </div>
//                                   </td>
//                                   <td>3-1-2022</td>
//                                   <td>
//                                     <span>Auto CAD</span>
//                                   </td>
//                                   <td>
//                                     <div class="avatar-list-stacked">
//                                       <span>2000</span>
//                                     </div>
//                                   </td>
//                                   <td>UPI</td>
//                                   <td>
//                                     <div class="hstack gap-2 fs-15">
//                                       <a
//                                         href="javascript:void(0);"
//                                         class="btn btn-icon btn-sm btn-soft-info rounded-pill"
//                                       >
//                                         <i class="feather-download"></i>
//                                       </a>
//                                       <a
//                                         href="javascript:void(0);"
//                                         class="btn btn-icon btn-sm btn-soft-info rounded-pill"
//                                       >
//                                         <i class="feather-edit"></i>
//                                       </a>
//                                       <a
//                                         href="javascript:void(0);"
//                                         class="btn btn-icon btn-sm btn-soft-danger rounded-pill"
//                                       >
//                                         <i class="feather-trash"></i>
//                                       </a>
//                                     </div>
//                                   </td>
//                                 </tr>
//                                 <tr>
//                                   <td>4</td>
//                                   <td>#4536478939</td>
//                                   <td>
//                                     <div class="d-flex align-items-center">
//                                       <div>
//                                         <div class="lh-1">
//                                           <span>Vijay kumar</span>
//                                         </div>
//                                         <div class="lh-1">
//                                           <span class="fs-11 text-muted">
//                                             <a
//                                               href="/cdn-cgi/l/email-protection"
//                                               class="__cf_email__"
//                                               data-cfemail="9cf6f3fdf2f2fdeff1f5e8f4ada8dcf9e4fdf1ecf0f9b2fff3f1"
//                                             >
//                                               +9964537264
//                                             </a>
//                                           </span>
//                                         </div>
//                                       </div>
//                                     </div>
//                                   </td>
//                                   <td>2-2-2024</td>
//                                   <td>
//                                     <span>Catia</span>
//                                   </td>
//                                   <td>
//                                     <div class="avatar-list-stacked">
//                                       <span>4000</span>
//                                     </div>
//                                   </td>
//                                   <td>NetBanking</td>
//                                   <td>
//                                     <div class="hstack gap-2 fs-15">
//                                       <a
//                                         href="javascript:void(0);"
//                                         class="btn btn-icon btn-sm btn-soft-info rounded-pill"
//                                       >
//                                         <i class="feather-download"></i>
//                                       </a>
//                                       <a
//                                         href="javascript:void(0);"
//                                         class="btn btn-icon btn-sm btn-soft-info rounded-pill"
//                                       >
//                                         <i class="feather-edit"></i>
//                                       </a>
//                                       <a
//                                         href="javascript:void(0);"
//                                         class="btn btn-icon btn-sm btn-soft-danger rounded-pill"
//                                       >
//                                         <i class="feather-trash"></i>
//                                       </a>
//                                     </div>
//                                   </td>
//                                 </tr>
//                               </tbody>
//                             </table>
//                           </div>
//                         </div>
//                       </div>
//                     </div>
//                   </div>

//                   <div class="load-btn text-center">
//                     <a href="javascript:void(0);" class="btn btn-primary">
//                       Loading<i class="ti ti-loader"></i>
//                     </a>
//                   </div>
//                 </div>
//               </div>
//               {/* <!-- /Card --> */}
//             </div>
//           </div>
//         </div>
//       </div>
//     </div>
//   );
// };

// export default FeeInvoiceGeneration;

import React, { useEffect, useState } from "react";
import axios from "axios";
import { jsPDF } from "jspdf";

const FeeInvoiceGeneration  = () => {
  const [registrations, setRegistrations] = useState([]);
  const [selectedCandidate, setSelectedCandidate] = useState({});
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [currentInstallmentIndex, setCurrentInstallmentIndex] = useState(null);
  const [isRecordingPayment, setIsRecordingPayment] = useState(false);
  const [isReceiptPreviewOpen, setIsReceiptPreviewOpen] = useState(false);
  const [currentReceiptDetails, setCurrentReceiptDetails] = useState(null);
  const [paymentDetails, setPaymentDetails] = useState({
    paidAmount: 0,
    paidDate: new Date().toISOString().split('T')[0],
    receivedBy: "",
    transactionId: "",
    // receiptDocument: anull
  });

  useEffect(() => {
    fetchRegistrations();
  }, []);

  const fetchRegistrations = async () => {
    try {
      const response = await axios.get("http://localhost:8080/api/registrations");
      setRegistrations(response.data);
    } catch (error) {
      console.error("Error fetching registrations:", error);
      alert("Failed to load registrations.");
    }
  };

  const fetchCandidateDetails = async (id) => {
    try {
      const response = await axios.get(`http://localhost:8080/api/registration/${id}`);
      const { __v, ...filteredData } = response.data;
      setSelectedCandidate(filteredData);
      setIsModalOpen(true);
    } catch (error) {
      console.error("Error fetching candidate details:", error);
      alert("Failed to fetch candidate details.");
    }
  };

  const handleShowPaymentForm = (index) => {
    const currentPayment = selectedCandidate.paymentsPlan?.[index] || {};
    setPaymentDetails({
      paidAmount: currentPayment.amount || 0,
      paidDate: new Date().toISOString().split('T')[0],
      receivedBy: "",
      transactionId: "",
      receiptDocument: null
    });
    
    setCurrentInstallmentIndex(index);
    setIsRecordingPayment(true);
  };

  const handlePaymentDetailsChange = (e) => {
    const { name, value, files } = e.target;
    
    if (name === "receiptDocument" && files && files[0]) {
      setPaymentDetails({
        ...paymentDetails,
        receiptDocument: files[0]
      });
    } else {
      setPaymentDetails({
        ...paymentDetails,
        [name]: value
      });
    }
  };

  const handleSubmitPayment = async () => {
    try {
      const formData = new FormData();
      formData.append('installmentIndex', currentInstallmentIndex);
      formData.append('paidAmount', paymentDetails.paidAmount);
      formData.append('paidDate', paymentDetails.paidDate);
      formData.append('receivedBy', paymentDetails.receivedBy);
      formData.append('transactionId', paymentDetails.transactionId);
      
      if (paymentDetails.receiptDocument) {
        formData.append('receiptDocument', paymentDetails.receiptDocument);
      }
      
      const response = await axios.post(
        `http://localhost:8080/api/record-payment/${selectedCandidate._id}`, 
        formData,
        { headers: { 'Content-Type': 'multipart/form-data' } }
      );
      
      const updatedCandidate = response.data;
      setSelectedCandidate(updatedCandidate);
      
      alert("Payment recorded successfully!");
      setIsRecordingPayment(false);
      fetchRegistrations();
    } catch (error) {
      console.error("Error recording payment:", error);
      alert("Failed to record payment.");
    }
  };

  const generateReceipt = (paymentDetails) => {
    const doc = new jsPDF();
    
    // Company Header
    doc.setFontSize(16);
    doc.text("Course Registration Payment Receipt", 105, 20, { align: "center" });
    doc.setFontSize(10);
    doc.text("CADDESK HYD", 105, 30, { align: "center" });
    doc.text("Contact: (123) 456-7890 | cadadesk@gmail.com", 105, 37, { align: "center" });
    
    // Horizontal Line
    doc.line(20, 45, 190, 45);
    
    // Student Information
    doc.setFontSize(12);
    doc.text(`Student Name: ${selectedCandidate.fName} ${selectedCandidate.lName}`, 20, 60);
    doc.text(`Course: ${selectedCandidate.courseName}`, 20, 70);
    doc.text(`Total Course Fee: ₹${selectedCandidate.courseFee}`, 20, 80);
    doc.text(`Fee Type: ${selectedCandidate.feeType === 'Single' ? 'Full Payment' : 'Installment'}`, 20, 90);
    
    // Payment Details
    doc.setFontSize(14);
    doc.text("Payment Details", 20, 110, { underline: true });
    
    doc.setFontSize(12);
    doc.text(`Installment: ${currentInstallmentIndex + 1}`, 20, 120);
    doc.text(`Amount Paid: ₹${paymentDetails.paidAmount}`, 20, 130);
    doc.text(`Payment Date: ${paymentDetails.paidDate}`, 20, 140);
    doc.text(`Transaction ID: ${paymentDetails.transactionId}`, 20, 150);
    doc.text(`Received By: ${paymentDetails.receivedBy}`, 20, 160);
    
    // Footer
    doc.setFontSize(10);
    doc.text("Thank you for your payment!", 105, 250, { align: "center" });
    doc.text("This is a computer-generated receipt", 105, 257, { align: "center" });
    
    // Signature Lines
    doc.line(20, 270, 80, 270);  // Student Signature
    doc.line(130, 270, 190, 270);  // Official Signature
    doc.text("Student Signature", 50, 280, { align: "center" });
    doc.text("Official Signature", 160, 280, { align: "center" });
    
    return doc;
  };

  const handleViewPaymentDetails = (index) => {
    const payment = selectedCandidate.paymentsPlan?.[index];
    if (payment) {
      setCurrentInstallmentIndex(index);
      setCurrentReceiptDetails({
        paidAmount: payment.paidAmount || paymentDetails.paidAmount,
        paidDate: payment.paidDate || paymentDetails.paidDate,
        receivedBy: payment.receivedBy || paymentDetails.receivedBy,
        transactionId: payment.transactionId || paymentDetails.transactionId
      });
      setIsReceiptPreviewOpen(true);
    } else {
      alert("Payment details not available.");
    }
  };

  const handleDownloadReceipt = () => {
    if (currentReceiptDetails) {
      const doc = generateReceipt(currentReceiptDetails);
      doc.save(`Receipt_${selectedCandidate.fName}_${selectedCandidate.lName}_Installment${currentInstallmentIndex + 1}.pdf`);
    }
  };

  const generatePaymentRows = () => {
    const paymentsPlan = selectedCandidate.paymentsPlan || [];
    
    return paymentsPlan.map((payment, index) => (
      <div key={index} className="row mb-3 border-bottom pb-3">
        <div className="col-xl-3">
          <label className="form-label">Due Date:</label>
          <input 
            type="date" 
            className="form-control"
            value={payment.dueDate || ""}
            readOnly
          />
        </div>
        <div className="col-xl-3">
          <label className="form-label">Amount:</label>
          <input 
            type="number" 
            className="form-control"
            value={payment.amount || 0}
            readOnly
          />
        </div>
        <div className="col-xl-3">
          <label className="form-label">Status:</label>
          <input 
            type="text" 
            className={`form-control ${
              payment.status === 'Paid' ? 'text-success' : 'text-warning'
            }`}
            value={payment.status || "Pending"}
            readOnly
          />
        </div>
        <div className="col-xl-3 d-flex align-items-end">
          {payment.status === "Pending" && (
            <button 
              type="button" 
              className="btn btn-sm btn-primary"
              onClick={() => handleShowPaymentForm(index)}
            >
              Record Payment
            </button>
          )}
          {payment.status === "Paid" && (
            <button 
              type="button" 
              className="btn btn-sm btn-info"
              onClick={() => handleViewPaymentDetails(index)}
            >
              View Receipt
            </button>
          )}
        </div>
      </div>
    ));
  };

  const renderPaymentForm = () => {
    if (!isRecordingPayment) return null;

    return (
      <div className="payment-form mt-4 border p-3 bg-light">
        <h5 className="mb-3">Record Payment for Installment {currentInstallmentIndex + 1}</h5>
        <div className="row g-3">
          <div className="col-md-6">
            <label className="form-label">Amount Paid:</label>
            <input 
              type="number" 
              className="form-control"
              name="paidAmount" 
              value={paymentDetails.paidAmount} 
              onChange={handlePaymentDetailsChange}
            />
          </div>
          <div className="col-md-6">
            <label className="form-label">Payment Date:</label>
            <input 
              type="date" 
              className="form-control"
              name="paidDate" 
              value={paymentDetails.paidDate} 
              onChange={handlePaymentDetailsChange}
            />
          </div>
          <div className="col-md-6">
            <label className="form-label">Received By:</label>
            <input 
              type="text" 
              className="form-control"
              name="receivedBy" 
              value={paymentDetails.receivedBy} 
              onChange={handlePaymentDetailsChange}
            />
          </div>
          <div className="col-md-6">
            <label className="form-label">Transaction ID:</label>
            <input 
              type="text" 
              className="form-control"
              name="transactionId" 
              value={paymentDetails.transactionId} 
              onChange={handlePaymentDetailsChange}
            />
          </div>
          <div className="col-12">
            <label className="form-label">Receipt Document:</label>
            <input 
              type="file" 
              className="form-control"
              name="receiptDocument" 
              onChange={handlePaymentDetailsChange}
            />
          </div>
          <div className="col-12 mt-3 text-end">
            <button 
              type="button" 
              className="btn btn-secondary me-2"
              onClick={() => setIsRecordingPayment(false)}
            >
              Cancel
            </button>
            <button 
              type="button" 
              className="btn btn-primary"
              onClick={handleSubmitPayment}
            >
              Save Payment
            </button>
          </div>
        </div>
      </div>
    );
  };

  const renderReceiptPreviewModal = () => {
    if (!isReceiptPreviewOpen || !currentReceiptDetails) return null;

    return (
      <div className="modal fade show" style={{display: 'block', backgroundColor: 'rgba(0,0,0,0.5)'}}>
        <div className="modal-dialog modal-lg">
          <div className="modal-content">
            <div className="modal-header">
              <h5 className="modal-title">Receipt Preview</h5>
              <button 
                type="button" 
                className="btn-close" 
                onClick={() => setIsReceiptPreviewOpen(false)}
              ></button>
            </div>
            <div className="modal-body">
              <div className="receipt-preview p-4 border">
                <div className="row">
                  <div className="col-12 text-center mb-4">
                    <h3>Payment Receipt</h3>
                    <p>Your Company Name</p>
                  </div>
                  <div className="col-md-6">
                    <h5>Student Details</h5>
                    <p><strong>Name:</strong> {selectedCandidate.fName} {selectedCandidate.lName}</p>
                    <p><strong>Course:</strong> {selectedCandidate.courseName}</p>
                    <p><strong>Total Fee:</strong> ₹{selectedCandidate.courseFee}</p>
                  </div>
                  <div className="col-md-6">
                    <h5>Payment Information</h5>
                    <p><strong>Installment:</strong> {currentInstallmentIndex + 1}</p>
                    <p><strong>Amount Paid:</strong> ₹{currentReceiptDetails.paidAmount}</p>
                    <p><strong>Payment Date:</strong> {currentReceiptDetails.paidDate}</p>
                    <p><strong>Transaction ID:</strong> {currentReceiptDetails.transactionId}</p>
                    <p><strong>Received By:</strong> {currentReceiptDetails.receivedBy}</p>
                  </div>
                </div>
              </div>
            </div>
            <div className="modal-footer">
              <button 
                type="button" 
                className="btn btn-secondary" 
                onClick={() => setIsReceiptPreviewOpen(false)}
              >
                Close
              </button>
              <button 
                type="button" 
                className="btn btn-primary" 
                onClick={handleDownloadReceipt}
              >
                Download Receipt
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  };

  return (
    <div>
      <div className="page-wrapper">
        <div className="content">
          <div className="row">
            <div className="col-md-12">
              <div className="page-header">
                <div className="row align-items-center">
                  <div className="col-8">
                    <h4>Payment Details</h4>
                  </div>
                </div>
              </div>

              <div className="card">
                <div className="card-body">
                  <table className="table table-striped">
                    <thead>
                      <tr>
                        <th>Name</th>
                        <th>Course</th>
                        <th>Total Fee</th>
                        <th>Fee Type</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {registrations.length > 0 ? (
                        registrations.map((registration) => (
                          <tr key={registration._id}>
                            <td>{registration.fName} {registration.lName}</td>
                            <td>{registration.courseName}</td>
                            <td>{registration.courseFee}</td>
                            <td>{registration.feeType === 'Single' ? 'Full Payment' : 'Installment'}</td>
                            <td>
                              <button 
                                className="btn btn-sm btn-primary"
                                onClick={() => fetchCandidateDetails(registration._id)}
                              >
                                View Payment Details
                              </button>
                            </td>
                          </tr>
                        ))
                      ) : (
                        <tr>
                          <td colSpan="5" className="text-center">No registrations found.</td>
                        </tr>
                      )}
                    </tbody>
                  </table>
                </div>
              </div>

              {/* Payment Details Modal */}
              {isModalOpen && selectedCandidate && (
                <div className="modal fade show" style={{display: 'block', backgroundColor: 'rgba(0,0,0,0.5)'}}>
                  <div className="modal-dialog modal-lg">
                    <div className="modal-content">
                      <div className="modal-header">
                        <h5 className="modal-title">
                          Payment Details - {selectedCandidate.fName} {selectedCandidate.lName}
                        </h5>
                        <button 
                          type="button" 
                          className="btn-close" 
                          onClick={() => setIsModalOpen(false)}
                        ></button>
                      </div>
                      <div className="modal-body">
                        <div className="row mb-3">
                          <div className="col-md-4">
                            <strong>Course:</strong> {selectedCandidate.courseName}
                          </div>
                          <div className="col-md-4">
                            <strong>Total Fee:</strong> {selectedCandidate.courseFee}
                          </div>
                          <div className="col-md-4">
                            <strong>Fee Type:</strong> {selectedCandidate.feeType === 'Single' ? 'Full Payment' : 'Installment'}
                          </div>
                        </div>

                        <h6 className="mt-3 mb-3">Payment Plan</h6>
                        {generatePaymentRows()}
                        
                        {renderPaymentForm()}
                      </div>
                      <div className="modal-footer">
                        <button 
                          type="button" 
                          className="btn btn-secondary" 
                          onClick={() => setIsModalOpen(false)}
                        >
                          Close
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      </div>

      {/* Receipt Preview Modal */}
      {renderReceiptPreviewModal()}
    </div>
  );
};

export default FeeInvoiceGeneration ;      

